name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Install mise
        uses: jdx/mise-action@146a28175021df8ca24f8ee1828cc2a60f980bd5 # v3

      - name: Install linters via mise
        run: |
          mise use -g shellcheck@latest
          mise use -g taplo@latest

      - name: Shellcheck (bash scripts)
        run: |
          shopt -s globstar nullglob
          scripts=(run_*.sh.tmpl)
          if [[ ${#scripts[@]} -gt 0 ]]; then
            for f in "${scripts[@]}"; do
              echo "Checking $f"
              # Extract bash from templates (remove template directives)
              sed '/^#.*{{/d; /{{.*}}/d' "$f" | shellcheck -s bash - || true
            done
          fi

      - name: Validate TOML files
        run: |
          find . -name "*.toml" -type f | while read -r f; do
            echo "Validating $f"
            taplo format --check "$f" || taplo check "$f"
          done

  fish-syntax:
    name: Fish Syntax
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Install Fish
        run: |
          sudo apt-add-repository -y ppa:fish-shell/release-3
          sudo apt-get update
          sudo apt-get install -y fish

      - name: Check Fish syntax
        run: |
          find . -name "*.fish" -type f | while read -r f; do
            echo "Checking $f"
            fish -n "$f"
          done

  chezmoi-verify:
    name: Chezmoi Verify
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Install mise
        uses: jdx/mise-action@146a28175021df8ca24f8ee1828cc2a60f980bd5 # v3

      - name: Install chezmoi
        run: mise use -g chezmoi@latest

      - name: Setup chezmoi
        run: |
          # Symlink checkout to chezmoi's expected source location
          mkdir -p ~/.local/share
          ln -s "$(pwd)" ~/.local/share/chezmoi

          # Create chezmoi config with test data
          # (bypasses interactive prompts from .chezmoi.toml.tmpl)
          mkdir -p ~/.config/chezmoi
          cat > ~/.config/chezmoi/chezmoi.toml << 'EOF'
          [data]
            name = "Test User"
            email = "test@example.com"
            machine_type = "personal"
          EOF

      - name: Verify templates render
        run: |
          # Test that all .tmpl files render without errors
          # Skip .chezmoi.toml.tmpl (uses promptStringOnce which only works during init)
          find . -name "*.tmpl" -type f ! -name ".chezmoi.toml.tmpl" | while read -r f; do
            echo "Testing template: $f"
            chezmoi execute-template < "$f" > /dev/null
          done

      - name: Check managed files
        run: |
          chezmoi managed
          chezmoi diff --no-pager || true
